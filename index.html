<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#4D6057">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <link rel="manifest" href="/manifest.json">
  <title>Acesso Médico - Caderneta Idoso</title>
  <link rel="icon" type="image/png" href="https://i.imgur.com/z8sFZHC.png">
  <link rel="apple-touch-icon" href="https://i.imgur.com/z8sFZHC.png">
  <script src="https://www.gstatic.com/firebasejs/9.0.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.2/firebase-storage-compat.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <style>
    .contact-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background-color: #4D6057;
      color: white;
      padding: 10px 15px;
      font-size: 14px;
      z-index: 1000;
      text-align: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
    }
    
    .contact-header a {
      color: white;
      text-decoration: none;
      transition: opacity 0.2s;
      white-space: nowrap;
    }
    
    .contact-header a:hover {
      opacity: 0.8;
      text-decoration: underline;
    }

    .contact-separator {
      display: inline-block;
    }

    @media (max-width: 600px) {
      .contact-header {
        font-size: 12px;
        padding: 8px 5px;
        gap: 8px;
        flex-direction: row;
        justify-content: center;
        flex-wrap: wrap;
      }
      
      .contact-separator {
        display: inline-block;
      }
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      font-size: 16px;
      margin: 0;
      padding-top: 50px;
      background-color: #f8f9fa;
      color: #333;
    }
    .container {
      max-width: 900px;
      margin: 20px auto;
      background: #fff;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      padding: 30px;
      border-radius: 12px;
      position: relative;
    }
    .popup {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #3b5448;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 16px;
      opacity: 0;
      transition: opacity 0.5s;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    .popup.show {
      opacity: 1;
    }
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    @media (max-width: 600px) {
      body {
        padding-top: 80px;
      }
    }
    
    /* Tela de Login Médico */
    #medicalLoginScreen {
      display: block;
      position: relative;
      background: white;
      padding: 20px;
      border-radius: 12px;
      width: 95%;
      max-width: 500px;
      margin: 20px auto;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      text-align: center;
    }
    
    #medicalLoginScreen h2 {
      text-align: center;
      margin-bottom: 20px;
      color: #4D6057;
    }
    
    .medical-search {
      width: 80%;
      max-width: 400px;
      padding: 10px;
      margin: 10px auto;
      border: 1px solid #ddd;
      border-radius: 8px;
      display: block;
    }
    
    .medical-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 20px;
    }
    
    .btn {
      margin-top: 20px;
      padding: 12px 20px;
      border: none;
      background: #3b5448;
      color: #fff;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: background-color 0.3s;
      width: 100%;
      max-width: 200px;
    }
    
    .btn:hover {
      background-color: #2d4036;
    }
    
    /* Tela de Acesso Médico */
    #medicalAccessScreen {
      display: none;
      position: relative;
      background: white;
      padding: 20px;
      border-radius: 12px;
      width: 95%;
      max-width: 800px;
      margin: 20px auto;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      text-align: center;
    }
    
    #medicalAccessScreen h2 {
      text-align: center;
      margin-bottom: 20px;
      color: #4D6057;
    }
    
    .user-list {
      max-height: 400px;
      overflow-y: auto;
      margin: 15px auto;
      width: 90%;
      max-width: 600px;
      text-align: left;
    }
    
    .user-item {
      padding: 15px;
      margin: 10px 0;
      background: #f8f9fa;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      text-align: left;
    }
    
    .user-item:hover {
      background: #e9ecef;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .user-name {
      font-weight: 600;
      font-size: 1.1em;
      margin-bottom: 5px;
    }
    
    .user-details {
      display: flex;
      justify-content: space-between;
      font-size: 0.9em;
      color: #666;
    }
    
    .no-users {
      text-align: center;
      color: #666;
      padding: 20px;
    }
    
    /* Tela de Geração de QR Code - Reduzida */
    #qrCodeScreen {
      display: none;
      position: relative;
      background: white;
      padding: 20px;
      border-radius: 12px;
      width: 95%;
      max-width: 400px;
      margin: 20px auto;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      text-align: center;
    }
    
    #qrCodeScreen h2 {
      text-align: center;
      margin-bottom: 15px;
      color: #4D6057;
      font-size: 1.3em;
    }
    
    #qrCodeScreen form {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    #qrCodeScreen label {
      display: block;
      margin-top: 8px;
      font-size: 14px;
      font-weight: 600;
      color: #495057;
      text-align: center;
      width: 100%;
    }
    
    #qrCodeScreen input {
      width: 90%;
      max-width: 350px;
      padding: 8px;
      margin: 5px auto;
      border: 1px solid #ddd;
      border-radius: 8px;
      display: block;
      text-align: center;
      font-size: 14px;
    }
    
    #qrCodeContainer {
      text-align: center;
      margin: 15px 0;
      display: none;
    }
    
    #qrCodeContainer canvas {
      width: 180px;
      height: 180px;
    }
    
    #qrCodeContainer p {
      margin-top: 8px;
      font-size: 13px;
      color: #666;
    }
    
    /* Tela de Detalhes do Paciente */
    #userDetailScreen {
      display: none;
      position: relative;
      background: white;
      padding: 20px;
      border-radius: 12px;
      width: 95%;
      max-width: 800px;
      margin: 20px auto;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      text-align: center;
    }
    
    #userDetailScreen h2 {
      text-align: center;
      margin-bottom: 20px;
      color: #4D6057;
    }
    
    #userDetailTabs {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 5px;
      margin-bottom: 20px;
    }
    
    .detail-tab {
      padding: 10px;
      text-align: center;
      background: #e9ecef;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 13px;
    }
    
    .detail-tab.active {
      background: #839c90;
      color: white;
    }
    
    .detail-tab-content {
      display: none;
      padding: 15px;
      border: 1px solid #eee;
      border-radius: 8px;
      margin-bottom: 15px;
      text-align: left;
      position: relative;
      z-index: 1;
    }
    
    .detail-tab-content.active {
      display: block;
      z-index: 2;
    }
    
    .compact-form {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      text-align: left;
    }
    
    .scrollable-detail {
      max-height: 60vh;
      overflow-y: auto;
      padding-right: 10px;
      text-align: left;
    }
    
    .detail-tab-content#detail-monitoramento {
      background-color: #fff9c4;
      padding: 15px;
      border-radius: 8px;
      text-align: left;
    }
    
    .monitoramento-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      margin: 5px 0;
      background-color: white;
      border-radius: 8px;
      text-align: left;
    }
    
    .delete-monitoramento-btn {
      background: #ff4444;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 5px;
      cursor: pointer;
    }
    
    .editable-field {
      border: 1px solid transparent;
      padding: 5px;
      margin: 5px 0;
      transition: all 0.3s;
      text-align: left;
    }
    
    .editing .editable-field {
      border-color: #4D6057;
      background-color: #f8f9fa;
    }
    
    .edit-input {
      width: 100%;
      padding: 8px;
      margin: 5px 0;
      border: 1px solid #ddd;
      border-radius: 4px;
      text-align: left;
    }
    
    .btn-danger {
      background-color: #dc3545;
    }
    
    .btn-danger:hover {
      background-color: #c82333;
    }
    
    .add-item-btn {
      margin: 10px 0;
      background: #4D6057;
    }
    
    /* Estilos para a aba "Peso" */
    .other-container {
      margin-bottom: 20px;
      padding: 15px;
      background-color: #f8f9fa;
      border-radius: 8px;
    }
    
    .other-container h3 {
      margin-top: 0;
      color: #4D6057;
      border-bottom: 1px solid #ddd;
      padding-bottom: 8px;
    }
    
    .other-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      margin: 5px 0;
      background-color: white;
      border-radius: 8px;
      text-align: left;
    }
    
    .other-item-content {
      flex-grow: 1;
    }
    
    .other-item-date {
      font-size: 0.8em;
      color: #666;
      margin-top: 5px;
    }
    
    .delete-other-btn {
      background: #ff4444;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 5px;
      cursor: pointer;
      margin-left: 10px;
    }
    
    .add-other-btn {
      margin-top: 10px;
      background: #4D6057;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
    }
    
    @media (max-width: 600px) {
      #userDetailTabs {
        grid-template-columns: repeat(3, 1fr);
      }
      
      .detail-tab {
        font-size: 12px;
        padding: 8px;
      }
      
      .compact-form {
        grid-template-columns: 1fr;
      }
      
      .user-details {
        flex-direction: column;
      }
      
      .medical-search {
        width: 90%;
      }
      
      .remember-me {
        width: 90%;
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <!-- Cabeçalho de contato simplificado -->
  <div class="contact-header">
    <a href="https://www.instagram.com/camillaribeirogeriatra" target="_blank" title="Acessar Instagram">
      <i class="fab fa-instagram"></i> @camillaribeirogeriatra
    </a>
    <span class="contact-separator">|</span>
    <a href="https://wa.me/5538999037071" title="Enviar mensagem no WhatsApp">
      <i class="fab fa-whatsapp"></i> (38) 99903-7071
    </a>
  </div>

  <!-- Tela de Login Médico -->
  <div id="medicalLoginScreen" class="container">
    <h2>Acesso Médico</h2>
    <input type="text" id="medUsername" placeholder="Usuário" class="medical-search">
    <input type="password" id="medPassword" placeholder="Senha" class="medical-search">
    <div class="remember-me">
      <input type="checkbox" id="rememberMe">
      <label for="rememberMe">Quero continuar logado</label>
    </div>
    <div class="medical-buttons">
      <button id="medLoginBtn" class="btn">Entrar</button>
    </div>
  </div>

  <!-- Tela de Acesso Médico -->
  <div id="medicalAccessScreen" class="container">
    <h2>Acesso Médico</h2>
    <input type="text" id="userSearch" placeholder="Pesquisar usuários..." class="medical-search">
    <div class="user-list" id="userList"></div>
    <div class="medical-buttons">
      <button id="generateQrBtn" class="btn">Gerar QR CODE</button>
      <button id="medLogoutBtn" class="btn btn-danger">Sair</button>
    </div>
  </div>

  <!-- Tela de Geração de QR Code - Reduzida -->
  <div id="qrCodeScreen" class="container">
    <h2>Gerar Novo Registro</h2>
    <form id="qrCodeForm">
      <label for="qrNome">Nome do Paciente:</label>
      <input type="text" id="qrNome" required>
      
      <label for="qrNascimento">Data de Nascimento:</label>
      <input type="date" id="qrNascimento" required>
      
      <div id="qrCodeContainer">
        <canvas id="qrCanvas"></canvas>
        <p>Escaneie este QR code para cadastrar automaticamente</p>
      </div>
      
      <div class="medical-buttons">
        <button type="button" id="generateQrCodeBtn" class="btn">Gerar QR</button>
        <button type="button" id="closeQrBtn" class="btn">Fechar</button>
      </div>
    </form>
  </div>

  <!-- Tela de Detalhes do Paciente -->
  <div id="userDetailScreen" class="container">
    <h2>Detalhes do Paciente</h2>
    <div id="userDetailTabs">
      <div class="detail-tab active" data-tab="detail-identificacao">Identificação</div>
      <div class="detail-tab" data-tab="detail-vacinacao">Vacinação</div>
      <div class="detail-tab" data-tab="detail-doencas">Doenças</div>
      <div class="detail-tab" data-tab="detail-medicamentos">Medicamentos</div>
      <div class="detail-tab" data-tab="detail-anotacoes">Anotações</div>
      <div class="detail-tab" data-tab="detail-monitoramento">Monitoramento</div>
      <div class="detail-tab" data-tab="detail-peso">Peso</div>
    </div>
    
    <div class="scrollable-detail">
      <div id="userDetailContent"></div>
    </div>

    <div class="medical-buttons">
      <button id="editUserBtn" class="btn" onclick="toggleEditMode()">Editar</button>
      <button id="saveUserBtn" class="btn" style="display: none;" onclick="saveUserChanges()">Salvar</button>
      <button class="btn btn-danger" onclick="deleteUser()">Excluir Usuário</button>
      <button onclick="closeUserDetail()" class="btn">Voltar</button>
    </div>
  </div>

  <div id="popup" class="popup">Dados salvos com sucesso!</div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    // Adicionando o prompt de instalação do PWA
    let deferredPrompt;
    
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      showInstallPrompt();
    });
    
    function showInstallPrompt() {
      if(deferredPrompt && confirm('Deseja instalar o aplicativo Caderneta do Idoso em seu dispositivo para melhor experiência?')) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choiceResult) => {
          if (choiceResult.outcome === 'accepted') {
            console.log('Usuário aceitou a instalação');
          } else {
            console.log('Usuário recusou a instalação');
          }
          deferredPrompt = null;
        });
      }
    }

    const firebaseConfig = {
      apiKey: "AIzaSyCMP_bBotEMngO0pLkxhrZvvgCJqIFTZCY",
      authDomain: "cadernetavirtualdoidoso.firebaseapp.com",
      projectId: "cadernetavirtualdoidoso",
      storageBucket: "cadernetavirtualdoidoso.appspot.com",
      messagingSenderId: "374078415962",
      appId: "1:374078415962:web:8d8566388ee8336f986463"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    let currentDetailTab = 'detail-identificacao';
    let userDetailUnsubscribe = null;
    let medicalAccessUnsubscribe = null;
    let currentEditingUser = null;
    let isEditing = false;
    let currentUserData = null;
    
    // Verificar se há credenciais salvas no localStorage
    function checkSavedCredentials() {
      const savedUsername = localStorage.getItem('medUsername');
      const savedPassword = localStorage.getItem('medPassword');
      
      if (savedUsername && savedPassword) {
        document.getElementById('medUsername').value = savedUsername;
        document.getElementById('medPassword').value = savedPassword;
        document.getElementById('rememberMe').checked = true;
      }
    }
    
    // Chamar a função ao carregar a página
    checkSavedCredentials();
    
    // Função melhorada para formatar datas
    function formatDate(dateString) {
      try {
        if (!dateString) return 'Data não informada';
        
        // Se for um timestamp do Firestore
        if (dateString.seconds) {
          const date = new Date(dateString.seconds * 1000);
          return date.toLocaleDateString('pt-BR');
        }
        
        // Se for uma string no formato ISO (contém 'T')
        if (dateString.includes('T')) {
          const date = new Date(dateString);
          return date.toLocaleDateString('pt-BR');
        }
        
        // Se for uma string no formato ANO-MES-DIA (formato do Firestore)
        if (dateString.includes('-')) {
          const [year, month, day] = dateString.split('-');
          return `${day}/${month}/${year}`;
        }
        
        return dateString; // Retorna original se não reconhecer o formato
      } catch (e) {
        console.error('Erro ao formatar data:', e);
        return 'Data inválida';
      }
    }

    document.getElementById('medLoginBtn').addEventListener('click', () => {
      const username = document.getElementById('medUsername').value;
      const password = document.getElementById('medPassword').value;
      const rememberMe = document.getElementById('rememberMe').checked;
      
      if(username === 'admin' && password === 'admin123') {
        // Salvar credenciais se o checkbox estiver marcado
        if (rememberMe) {
          localStorage.setItem('medUsername', username);
          localStorage.setItem('medPassword', password);
        } else {
          // Remover credenciais salvas se o checkbox não estiver marcado
          localStorage.removeItem('medUsername');
          localStorage.removeItem('medPassword');
        }
        
        document.getElementById('medicalLoginScreen').style.display = 'none';
        loadMedicalAccess();
      } else {
        alert('Credenciais inválidas!');
      }
    });

    async function loadMedicalAccess() {
      document.getElementById('medicalAccessScreen').style.display = 'block';
      
      if (medicalAccessUnsubscribe) {
        medicalAccessUnsubscribe();
      }
      
      medicalAccessUnsubscribe = db.collection('usuarios').onSnapshot(snapshot => {
        const users = [];
        snapshot.forEach(doc => {
          const userData = doc.data();
          users.push({ 
            id: doc.id,
            nome: userData.identificacao.nome,
            dataNascimento: userData.identificacao.dataNascimento
          });
        });
        
        users.sort((a, b) => a.nome.localeCompare(b.nome));
        
        displayUsers(users);
        
        const searchInput = document.getElementById('userSearch');
        searchInput.oninput = (e) => {
          const term = e.target.value.toLowerCase();
          const filtered = users.filter(user => 
            user.nome.toLowerCase().includes(term) ||
            user.id.toLowerCase().includes(term) ||
            user.dataNascimento.includes(term)
          );
          displayUsers(filtered);
        };
      }, error => {
        console.error('Erro na escuta em tempo real:', error);
        showPopup('Erro ao carregar pacientes!', true);
      });
    }

    function displayUsers(users) {
      const userList = document.getElementById('userList');
      
      if (users.length === 0) {
        userList.innerHTML = '<p class="no-users">Nenhum paciente encontrado</p>';
        return;
      }
      
      userList.innerHTML = users.map(user => `
        <div class="user-item" onclick="showUserDetail('${user.id}')" data-patient-id="${user.id}">
          <div class="user-name">${user.nome}</div>
          <div class="user-details">
            <span class="user-id">ID: ${user.id}</span>
            <span class="user-birth">Nasc: ${user.dataNascimento}</span>
          </div>
        </div>
      `).join('');
    }

    async function showUserDetail(userId) {
      currentEditingUser = userId;
      if(userDetailUnsubscribe) userDetailUnsubscribe();
      
      try {
        const doc = await db.collection('usuarios').doc(userId).get();
        if(doc.exists) {
          currentUserData = doc.data();
          renderUserDetail(currentUserData);
          document.getElementById('medicalAccessScreen').style.display = 'none';
          document.getElementById('userDetailScreen').style.display = 'block';
          
          userDetailUnsubscribe = db.collection('usuarios').doc(userId).onSnapshot(doc => {
            if(doc.exists) {
              currentUserData = doc.data();
              renderUserDetail(currentUserData);
            }
          });
        }
      } catch (error) {
        console.error('Erro ao carregar detalhes:', error);
        showPopup('Erro ao carregar dados do paciente!', true);
      }
    }

    function renderUserDetail(userData) {
      const detailContent = document.getElementById('userDetailContent');
      
      detailContent.innerHTML = `
        <div class="detail-tab-content active" id="detail-identificacao">
          <div class="compact-form">
            <div class="form-row">
              <label>Nome:</label>
              ${isEditing ? 
                `<input type="text" class="edit-input" data-field="identificacao.nome" value="${userData.identificacao.nome}">` : 
                `<span>${userData.identificacao.nome}</span>`}
            </div>
            <div class="form-row">
              <label>Nascimento:</label>
              ${isEditing ? 
                `<input type="date" class="edit-input" data-field="identificacao.dataNascimento" value="${userData.identificacao.dataNascimento}">` : 
                `<span>${userData.identificacao.dataNascimento}</span>`}
            </div>
            <div class="form-row">
              <label>Contato:</label>
              ${isEditing ? 
                `<input type="tel" class="edit-input" data-field="identificacao.contato" value="${userData.identificacao.contato}">` : 
                `<span>${userData.identificacao.contato}</span>`}
            </div>
            <div class="form-row">
              <label>Contato de Emergência:</label>
              ${isEditing ? 
                `<input type="tel" class="edit-input" data-field="identificacao.contatoEmergencia" value="${userData.identificacao.contatoEmergencia || ''}">` : 
                `<span>${userData.identificacao.contatoEmergencia || 'Não informado'}</span>`}
            </div>
            <div class="form-row">
              <label>Peso:</label>
              ${isEditing ? 
                `<input type="number" class="edit-input" data-field="identificacao.peso" value="${userData.identificacao.peso}">` : 
                `<span>${userData.identificacao.peso}</span>`}
            </div>
          </div>
        </div>

        <div class="detail-tab-content" id="detail-vacinacao">
          ${(userData.vacinacao || []).map((vacina, index) => `
            <div class="vacina-form" data-index="${index}">
              <div class="form-row">
                <label>Vacina:</label>
                ${isEditing ? 
                  `<input type="text" class="edit-input" data-field="vacinacao[${index}].nomeVacina" value="${vacina.nomeVacina || ''}">` : 
                  `<span>${vacina.nomeVacina || 'Não informado'}</span>`}
              </div>
              <div class="form-row">
                <label>Data:</label>
                ${isEditing ? 
                  `<input type="date" class="edit-input" data-field="vacinacao[${index}].dataAplicacao" value="${vacina.dataAplicacao || ''}">` : 
                  `<span>${vacina.dataAplicacao ? formatDate(vacina.dataAplicacao) : 'Não informado'}</span>`}
              </div>
              <div class="form-row">
                <label>Lote:</label>
                ${isEditing ? 
                  `<input type="text" class="edit-input" data-field="vacinacao[${index}].loteVacina" value="${vacina.loteVacina || ''}">` : 
                  `<span>${vacina.loteVacina || 'Não informado'}</span>`}
              </div>
              <div class="form-row">
                <label>Observações:</label>
                ${isEditing ? 
                  `<textarea class="edit-input" data-field="vacinacao[${index}].observacoes">${vacina.observacoes || ''}</textarea>` : 
                  `<span>${vacina.observacoes || 'Nenhuma'}</span>`}
              </div>
              ${isEditing ? `<button class="delete-btn" onclick="this.closest('.vacina-form').remove()">Excluir</button>` : ''}
            </div>
          `).join('')}
          ${isEditing ? `<button class="btn add-item-btn" onclick="addNewVacina()">+ Nova Vacina</button>` : ''}
        </div>

        <div class="detail-tab-content" id="detail-doencas">
          <div class="compact-form">
            <div class="form-row">
              <label>Hipertensão:</label>
              <input type="checkbox" ${userData.doencas?.hipertensao ? 'checked' : ''} 
                ${isEditing ? 'data-field="doencas.hipertensao"' : 'disabled'}>
            </div>
            <div class="form-row">
              <label>Diabetes:</label>
              <input type="checkbox" ${userData.doencas?.diabetes ? 'checked' : ''} 
                ${isEditing ? 'data-field="doencas.diabetes"' : 'disabled'}>
            </div>
            <div class="form-row">
              <label>Cardiopatias:</label>
              <input type="checkbox" ${userData.doencas?.cardiopatias ? 'checked' : ''} 
                ${isEditing ? 'data-field="doencas.cardiopatias"' : 'disabled'}>
            </div>
            <div class="form-row">
              <label>Chagas:</label>
              <input type="checkbox" ${userData.doencas?.chagas ? 'checked' : ''} 
                ${isEditing ? 'data-field="doencas.chagas"' : 'disabled'}>
            </div>
            <div class="form-row">
              <label>Outras:</label>
              ${isEditing ? 
                `<input type="text" class="edit-input" data-field="doencas.outras" value="${userData.doencas?.outras || ''}">` : 
                `<span>${userData.doencas?.outras || 'Nenhuma'}</span>`}
            </div>
          </div>
        </div>

        <div class="detail-tab-content" id="detail-medicamentos">
          ${(userData.medicamentos || []).map((med, index) => `
            <div class="medicamento-form" data-index="${index}">
              <div class="form-row">
                <label>Medicamento:</label>
                ${isEditing ? 
                  `<input type="text" class="edit-input" data-field="medicamentos[${index}].nome" value="${med.nome || ''}">` : 
                  `<span>${med.nome || 'Não informado'}</span>`}
              </div>
              <div class="form-row">
                <label>Dose:</label>
                ${isEditing ? 
                  `<input type="text" class="edit-input" data-field="medicamentos[${index}].dose" value="${med.dose || ''}">` : 
                  `<span>${med.dose || 'Não informado'}</span>`}
              </div>
              <div class="form-row">
                <label>Posologia:</label>
                ${isEditing ? 
                  `<input type="text" class="edit-input" data-field="medicamentos[${index}].posologia" value="${med.posologia || ''}">` : 
                  `<span>${med.posologia || 'Não informado'}</span>`}
              </div>
              <div class="form-row">
                <label>Horário:</label>
                ${isEditing ? 
                  `<input type="time" class="edit-input" data-field="medicamentos[${index}].horario" value="${med.horario || ''}">` : 
                  `<span>${med.horario || 'Não informado'}</span>`}
              </div>
              ${isEditing ? `<button class="delete-btn" onclick="this.closest('.medicamento-form').remove()">Excluir</button>` : ''}
            </div>
          `).join('')}
          ${isEditing ? `<button class="btn add-item-btn" onclick="addNewMedicamento()">+ Novo Medicamento</button>` : ''}
        </div>

        <div class="detail-tab-content" id="detail-anotacoes">
          <div class="form-row">
            ${isEditing ? 
              `<textarea class="edit-input" data-field="anotacoes">${userData.anotacoes || ''}</textarea>` : 
              `<span>${userData.anotacoes || 'Nenhuma anotação'}</span>`}
          </div>
        </div>

        <div class="detail-tab-content" id="detail-monitoramento">
          ${(userData.monitoramento || []).map((entry, index) => `
            <div class="monitoramento-item">
              <div>
                <strong>PA:</strong> ${entry.pa || 'Não informado'}<br>
                <strong>Glicemia:</strong> ${entry.glicemia || 'Não informado'}<br>
                <em>${entry.timestamp ? formatDate(entry.timestamp) : 'Data não informada'}</em>
              </div>
              <button class="delete-monitoramento-btn" onclick="deleteMonitoramentoEntry('${currentEditingUser}', '${entry.timestamp}')">
                Excluir
              </button>
            </div>
          `).join('')}
        </div>

        <div class="detail-tab-content" id="detail-peso">
          <div class="other-container">
            <h3>Registros de Peso</h3>
            ${(userData.weightRecords || []).map((record, index) => {
              const recordDate = record.date ? formatDate(record.date) : 'Data não informada';
              
              return `
                <div class="other-item">
                  <div class="other-item-content">
                    <div>${record.weight || '0'} kg</div>
                    <div class="other-item-date">${recordDate}</div>
                  </div>
                  ${isEditing ? `
                    <button class="delete-other-btn" onclick="deleteOtherEntry('weightRecords', ${JSON.stringify(record.date)})">
                      Excluir
                    </button>
                  ` : ''}
                </div>
              `;
            }).join('')}
            ${isEditing ? `
              <button class="add-other-btn" onclick="addNewOtherEntry('weightRecords')">
                + Adicionar Peso
              </button>
            ` : ''}
          </div>
        </div>
      `;

      document.querySelectorAll('.detail-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.detail-tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.detail-tab-content').forEach(c => c.classList.remove('active'));
          tab.classList.add('active');
          const targetTab = tab.dataset.tab;
          document.getElementById(targetTab).classList.add('active');
          currentDetailTab = targetTab;
        });
      });

      // Mantém a aba ativa mesmo durante a edição
      if (currentDetailTab) {
        const activeTab = document.querySelector(`.detail-tab[data-tab="${currentDetailTab}"]`);
        if (activeTab) {
          activeTab.classList.add('active');
          document.getElementById(currentDetailTab).classList.add('active');
        }
      }
    }

    function addNewMedicamento() {
      const container = document.querySelector('#detail-medicamentos');
      const newIndex = container.querySelectorAll('.medicamento-form').length;
      
      const newMed = document.createElement('div');
      newMed.className = 'medicamento-form';
      newMed.innerHTML = `
        <div class="form-row">
          <label>Medicamento:</label>
          <input type="text" class="edit-input" data-field="medicamentos[${newIndex}].nome">
        </div>
        <div class="form-row">
          <label>Dose:</label>
          <input type="text" class="edit-input" data-field="medicamentos[${newIndex}].dose">
        </div>
        <div class="form-row">
          <label>Posologia:</label>
          <input type="text" class="edit-input" data-field="medicamentos[${newIndex}].posologia">
        </div>
        <div class="form-row">
          <label>Horário:</label>
          <input type="time" class="edit-input" data-field="medicamentos[${newIndex}].horario">
        </div>
        <button class="delete-btn" onclick="this.closest('.medicamento-form').remove()">Excluir</button>
      `;
      container.insertBefore(newMed, container.lastElementChild);
    }

    function addNewVacina() {
      const container = document.querySelector('#detail-vacinacao');
      const newIndex = container.querySelectorAll('.vacina-form').length;
      
      const newVac = document.createElement('div');
      newVac.className = 'vacina-form';
      newVac.innerHTML = `
        <div class="form-row">
          <label>Vacina:</label>
          <input type="text" class="edit-input" data-field="vacinacao[${newIndex}].nomeVacina">
        </div>
        <div class="form-row">
          <label>Data:</label>
          <input type="date" class="edit-input" data-field="vacinacao[${newIndex}].dataAplicacao">
        </div>
        <div class="form-row">
          <label>Lote:</label>
          <input type="text" class="edit-input" data-field="vacinacao[${newIndex}].loteVacina">
        </div>
        <div class="form-row">
          <label>Observações:</label>
          <textarea class="edit-input" data-field="vacinacao[${newIndex}].observacoes"></textarea>
        </div>
        <button class="delete-btn" onclick="this.closest('.vacina-form').remove()">Excluir</button>
      `;
      container.insertBefore(newVac, container.lastElementChild);
    }

    function toggleEditMode() {
      isEditing = !isEditing;
      document.getElementById('editUserBtn').style.display = isEditing ? 'none' : 'block';
      document.getElementById('saveUserBtn').style.display = isEditing ? 'block' : 'none';
      
      // Mantém a aba atual ativa ao entrar no modo de edição
      const activeTab = document.querySelector(`.detail-tab[data-tab="${currentDetailTab}"]`);
      if (activeTab) {
        renderUserDetail(currentUserData);
        activeTab.classList.add('active');
        document.getElementById(currentDetailTab).classList.add('active');
      } else {
        renderUserDetail(currentUserData);
      }
    }

    async function saveUserChanges() {
      try {
        const userRef = db.collection('usuarios').doc(currentEditingUser);
        const updatedData = { ...currentUserData };

        // Validação dos campos obrigatórios
        const nome = document.querySelector('[data-field="identificacao.nome"]')?.value;
        const dataNascimento = document.querySelector('[data-field="identificacao.dataNascimento"]')?.value;
        
        if (!nome || !dataNascimento) {
          showPopup('Nome e data de nascimento são obrigatórios!', true);
          return;
        }

        updatedData.identificacao = {
          nome: nome,
          dataNascimento: dataNascimento,
          contato: document.querySelector('[data-field="identificacao.contato"]')?.value || '',
          contatoEmergencia: document.querySelector('[data-field="identificacao.contatoEmergencia"]')?.value || '',
          peso: document.querySelector('[data-field="identificacao.peso"]')?.value || ''
        };

        updatedData.doencas = {
          hipertensao: document.querySelector('[data-field="doencas.hipertensao"]')?.checked || false,
          diabetes: document.querySelector('[data-field="doencas.diabetes"]')?.checked || false,
          cardiopatias: document.querySelector('[data-field="doencas.cardiopatias"]')?.checked || false,
          chagas: document.querySelector('[data-field="doencas.chagas"]')?.checked || false,
          outras: document.querySelector('[data-field="doencas.outras"]')?.value || ''
        };

        updatedData.vacinacao = Array.from(document.querySelectorAll('#detail-vacinacao .vacina-form')).map(form => ({
          nomeVacina: form.querySelector('[data-field$=".nomeVacina"]')?.value || '',
          dataAplicacao: form.querySelector('[data-field$=".dataAplicacao"]')?.value || '',
          loteVacina: form.querySelector('[data-field$=".loteVacina"]')?.value || '',
          observacoes: form.querySelector('[data-field$=".observacoes"]')?.value || ''
        }));

        updatedData.medicamentos = Array.from(document.querySelectorAll('#detail-medicamentos .medicamento-form')).map(form => ({
          nome: form.querySelector('[data-field$=".nome"]')?.value || '',
          dose: form.querySelector('[data-field$=".dose"]')?.value || '',
          posologia: form.querySelector('[data-field$=".posologia"]')?.value || '',
          horario: form.querySelector('[data-field$=".horario"]')?.value || ''
        }));

        updatedData.anotacoes = document.querySelector('[data-field="anotacoes"]')?.value || '';

        await userRef.set(updatedData, { merge: true });
        
        // Forçar atualização do cache local
        const doc = await userRef.get();
        currentUserData = doc.data();
        
        showPopup('Alterações salvas com sucesso!');
        toggleEditMode();
      } catch (error) {
        console.error('Erro ao salvar alterações:', error);
        showPopup('Erro ao salvar alterações!', true);
      }
    }

    async function deleteUser() {
      if(confirm('Tem certeza que deseja excluir este usuário permanentemente?')) {
        try {
          await db.collection('usuarios').doc(currentEditingUser).delete();
          showPopup('Usuário excluído com sucesso!');
          closeUserDetail();
          loadMedicalAccess();
        } catch (error) {
          console.error('Erro ao excluir usuário:', error);
          showPopup('Erro ao excluir usuário!', true);
        }
      }
    }

    function closeUserDetail() {
      if(userDetailUnsubscribe) {
        userDetailUnsubscribe();
        userDetailUnsubscribe = null;
      }
      currentEditingUser = null;
      currentDetailTab = 'detail-identificacao';
      document.getElementById('userDetailScreen').style.display = 'none';
      document.getElementById('medicalAccessScreen').style.display = 'block';
    }

    document.getElementById('medLogoutBtn').addEventListener('click', () => {
      if (medicalAccessUnsubscribe) {
        medicalAccessUnsubscribe();
        medicalAccessUnsubscribe = null;
      }
      // Limpar credenciais salvas ao fazer logout
      localStorage.removeItem('medUsername');
      localStorage.removeItem('medPassword');
      
      document.getElementById('medicalAccessScreen').style.display = 'none';
      document.getElementById('medicalLoginScreen').style.display = 'block';
    });

    document.getElementById('generateQrBtn').addEventListener('click', () => {
      document.getElementById('medicalAccessScreen').style.display = 'none';
      document.getElementById('qrCodeScreen').style.display = 'block';
    });

    document.getElementById('closeQrBtn').addEventListener('click', () => {
      document.getElementById('qrCodeScreen').style.display = 'none';
      document.getElementById('medicalAccessScreen').style.display = 'block';
    });

    document.getElementById('generateQrCodeBtn').addEventListener('click', async () => {
      const nome = document.getElementById('qrNome').value;
      const dataNascimento = document.getElementById('qrNascimento').value;
      
      if(!nome || !dataNascimento) {
        alert('Por favor, preencha todos os campos obrigatórios!');
        return;
      }
      
      const pacienteData = {
        nome: nome,
        dataNascimento: dataNascimento,
        timestamp: new Date().toISOString()
      };
      
      const qrData = JSON.stringify(pacienteData);
      
      QRCode.toCanvas(document.getElementById('qrCanvas'), qrData, { width: 200 }, (error) => {
        if (error) {
          console.error('Erro ao gerar QR Code:', error);
          showPopup('Erro ao gerar QR Code!', true);
        } else {
          document.getElementById('qrCodeContainer').style.display = 'block';
          showPopup('QR Code gerado com sucesso!');
        }
      });
    });

    async function deleteMonitoramentoEntry(username, timestamp) {
      try {
        const userRef = db.collection('usuarios').doc(username);
        const userDoc = await userRef.get();
        const monitoramento = userDoc.data().monitoramento || [];
        const updatedMonitoramento = monitoramento.filter(entry => entry.timestamp !== timestamp);

        await userRef.update({ monitoramento: updatedMonitoramento });
        showPopup('Registro de monitoramento excluído com sucesso!');
        if (document.getElementById('userDetailScreen').style.display === 'block') {
          renderUserDetail({ ...userDoc.data(), monitoramento: updatedMonitoramento });
        }
      } catch (error) {
        console.error('Erro ao excluir registro de monitoramento:', error);
        showPopup('Erro ao excluir registro de monitoramento!', true);
      }
    }

    async function deleteOtherEntry(field, date) {
      if(confirm('Tem certeza que deseja excluir este registro?')) {
        try {
          const userRef = db.collection('usuarios').doc(currentEditingUser);
          const userDoc = await userRef.get();
          const currentData = userDoc.data()[field] || [];
          
          // Comparação de datas considerando tanto string quanto timestamp
          const updatedData = currentData.filter(item => {
            if (item.date && item.date.seconds && date.seconds) {
              return item.date.seconds !== date.seconds;
            } else if (typeof item.date === 'string' && typeof date === 'string') {
              return item.date !== date;
            }
            return true;
          });

          await userRef.update({ [field]: updatedData });
          showPopup('Registro excluído com sucesso!');
          if (document.getElementById('userDetailScreen').style.display === 'block') {
            renderUserDetail({ ...userDoc.data(), [field]: updatedData });
          }
        } catch (error) {
          console.error(`Erro ao excluir registro de ${field}:`, error);
          showPopup('Erro ao excluir registro!', true);
        }
      }
    }

    function addNewOtherEntry(field) {
      let newEntry = {};
      let promptMessage = '';
      let defaultValue = '';

      if (field === 'weightRecords') {
        promptMessage = 'Digite o peso (em kg):';
        defaultValue = '70';
      }

      const userInput = prompt(promptMessage, defaultValue);
      if (!userInput) return;

      const today = new Date().toISOString().split('T')[0];
      const dateInput = prompt('Digite a data (formato YYYY-MM-DD):', today);
      if (!dateInput) return;

      if (field === 'weightRecords') {
        newEntry = {
          weight: userInput,
          date: dateInput
        };
      }

      saveOtherEntry(field, newEntry);
    }

    async function saveOtherEntry(field, newEntry) {
      try {
        const userRef = db.collection('usuarios').doc(currentEditingUser);
        const userDoc = await userRef.get();
        const currentData = userDoc.data()[field] || [];
        
        // Verifica se já existe um registro com a mesma data
        const existingIndex = currentData.findIndex(item => {
          if (item.date && item.date.seconds && newEntry.date.seconds) {
            return item.date.seconds === newEntry.date.seconds;
          } else if (typeof item.date === 'string' && typeof newEntry.date === 'string') {
            return item.date === newEntry.date;
          }
          return false;
        });
        
        let updatedData;
        
        if (existingIndex >= 0) {
          // Atualiza o registro existente
          updatedData = [...currentData];
          updatedData[existingIndex] = newEntry;
        } else {
          // Adiciona novo registro
          updatedData = [...currentData, newEntry];
        }

        await userRef.update({ [field]: updatedData });
        showPopup('Registro salvo com sucesso!');
        
        // Atualiza a exibição
        const updatedDoc = await userRef.get();
        renderUserDetail(updatedDoc.data());
      } catch (error) {
        console.error(`Erro ao salvar registro em ${field}:`, error);
        showPopup('Erro ao salvar registro!', true);
      }
    }

    function showPopup(message, isError = false) {
      const popup = document.getElementById('popup');
      popup.textContent = message;
      popup.style.backgroundColor = isError ? '#dc3545' : '#3b5448';
      popup.classList.add('show');
      setTimeout(() => popup.classList.remove('show'), 3000);
    }

    // Registrar o Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then(registration => {
            console.log('Service Worker registrado:', registration.scope);
          })
          .catch(error => {
            console.log('Falha no registro:', error);
          });
      });
    }
  </script>
</body>
</html>
